# Replication（下）：事务，一致性与共识
- URL: https://tech.meituan.com/2022/08/25/replication-in-meituan-02.html
- Added At: 2025-05-27 03:45:47
- [Link To Text](2025-05-27-replication（下）：事务，一致性与共识_raw.md)

## TL;DR
本文总结了分布式系统中的核心问题与解决方案，包括事务、一致性、共识算法等，并介绍了Kafka的复制设计和验证工具TLA+、Jepsen。文章强调了一致性的重要性及实现方式，为分布式系统设计提供了理论指导和实践参考。

## Summary
1. **前文回顾**  
   - 介绍了分布式系统中常见的三种复制模型：  
     - 主从复制模型  
     - 多主复制模型  
     - 无主复制模型  
   - 讨论了复制的时效性：  
     - 同步复制  
     - 异步复制（可能导致数据不一致）  
   - 分布式系统的特有挑战：  
     - 部分失效  
     - 不可靠的时钟问题  
   - 系统模型假设：  
     - 半同步模型（处理超时）  
     - 崩溃-恢复模型（节点失效）  
     - 优先保证Safety（安全性），Liveness（活性）需在特定前提下满足  

2. **本文简介**  
   - 重点解决分布式系统中的挑战：  
     - 事务  
     - 一致性  
     - 共识  
   - 后续内容：  
     - Kafka复制设计分析  
     - 分布式算法验证工具  

3. **事务与外部一致性**  
   - **事务的产生**：  
     - 解决系统故障（硬件、应用、网络）  
     - 避免数据覆盖和读取过期数据  
   - **ACID特性**：  
     - **原子性（Atomicity）**：  
       - 操作集合不可分割  
       - 故障时回滚或无副作用  
     - **一致性（Consistency）**：  
       - 维护数据“不变式”  
       - 需应用程序共同保证  
     - **隔离性（Isolation）**：  
       - 解决并发事务问题  
       - 最高级别为“可序列化”（Serializability）  
     - **持久性（Durability）**：  
       - 事务完成后数据不丢失  
   - **事务操作对象**：  
     - 单对象写入（如JSON、Counter）  
     - 多对象事务（跨分区、跨系统，更复杂）  
   - **弱隔离级别**：  
     - 解决的问题：  
       - 脏读  
       - 脏写  
       - 读偏差（不可重复读）  
       - 更新丢失  
       - 写偏差（幻读）  
     - 隔离级别对比：  
       | 隔离级别               | 脏读 | 脏写 | 读偏差 | 更新丢失 | 写偏差 |  
       |------------------------|------|------|--------|----------|--------|  
       | 读已提交               | Y    | Y    | N      | N        | N      |  
       | 可重复读（快照隔离）   | Y    | Y    | Y      | Maybe    | N      |  
       | 可串行化               | Y    | Y    | Y      | Y        | Y      |  

4. **内部一致性与共识**  
   - **复制滞后性问题**：  
     - 写后读一致性  
     - 单调读一致性  
     - 前缀读一致性  
   - **内部一致性分类**：  
     - 线性一致性（强一致）  
     - 顺序一致性  
     - 因果一致性  
     - 最终一致性  
   - **线性一致性实现**：  
     - 主从复制（部分支持）  
     - 共识算法（如Raft）  
     - 全序广播（如ZAB）  
   - **共识算法**：  
     - 特性：  
       1. 协商一致性  
       2. 诚实性  
       3. 合法性  
       4. 可终止性  
     - 实现方式：  
       - 两阶段提交（2PC）  
       - 外包共识（如ZK、etcd）  

5. **再谈分布式系统**  
   - 理想系统的目标：  
     - 线性一致性（单副本外观）  
     - 串行化（单客户端外观）  
   - 一致性的正交性：  
     - 内部一致性（单操作单对象）  
     - 外部一致性（多操作多对象）  

6. **Kafka复制设计分析**  
   - 复制配置：  
     - `acks=0/1`：异步复制（非线性一致）  
     - `acks=all`：同步复制（需配置`min.insync.replicas`）  
   - 高版本改进：  
     - 自主Controller选主（Kraft替代ZK）  
     - 事务支持（2PC实现）  

7. **分布式系统验证框架**  
   - **TLA+**：  
     - 白盒建模工具  
     - 基于数学规约验证系统行为  
   - **Jepsen**：  
     - 黑盒测试工具  
     - 通过故障注入验证一致性  

8. **小结**  
   - 分布式系统的核心问题与解决方案  
   - 工具链对系统验证的重要性  

9. **作者简介**  
   - 仕禄，美团基础研发平台工程师
